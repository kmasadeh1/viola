<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Viola Academy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <link rel="stylesheet" href="style.css">
    <style>
        /* Shared Styles */
        .drop-zone { width: 100%; height: 150px; padding: 20px; border: 2px dashed #ccc; border-radius: 10px; display: flex; align-items: center; justify-content: center; text-align: center; cursor: pointer; background: #f8f9fa; margin-bottom: 15px; position: relative; }
        .drop-zone.dragover { background-color: #e8f5e9; border-color: #2ecc71; transform: scale(1.02); }
        .preview-img, #lunchPreview { max-height: 100%; max-width: 100%; display: none; border-radius: 5px; object-fit: contain; }
        .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
        .modal-content { background:white; margin:5% auto; padding:2rem; width:90%; max-width:600px; border-radius:15px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px; }
        .btn { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-primary { background: #2ecc71; color: white; }
        .btn-secondary { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f1c40f; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .admin-timeline-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #2ecc71; }
        .btn-delete-sm { background: #ffebee; color: red; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .schedule-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .schedule-time { width: 100px; font-weight: bold; color: #555; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .msg-history-item { border-left: 4px solid #e74c3c; background: #fff; padding: 10px; margin-bottom: 8px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .order-card { background: white; border: 1px solid #eee; border-left: 5px solid #f1c40f; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .login-section { background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #90caf9; margin-bottom: 15px; grid-column: span 2; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 300px; }
        
        /* Homework Styles */
        .homework-item { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .homework-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #eee; color: #555; margin-right: 5px; }
        
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { background: #f8f9fa; font-weight: bold; color: #555; }
    </style>
</head>
<body>
    <div class="lang-toggle" onclick="toggleLanguage()">
        <i class="fas fa-globe"></i> <span>English / العربية</span>
    </div>
    <nav>
        <div class="logo-container">
            <img src="logo.png" alt="Logo" class="nav-logo">
            <div class="brand-name">Viola Admin</div>
        </div>
        <ul class="nav-links"><li><a href="index.html" data-en="Log Out" data-ar="تسجيل الخروج">Log Out</a></li></ul>
    </nav>
    <div class="admin-layout">
        <div class="admin-sidebar">
            <button class="sidebar-btn active" onclick="showPanel('students')"><i class="fas fa-user-graduate"></i> <span data-en="Students" data-ar="الطلاب">Students</span></button>
            <button class="sidebar-btn" onclick="showPanel('teachers')"><i class="fas fa-chalkboard-teacher"></i> <span data-en="Teachers" data-ar="المعلمين">Teachers</span></button>
            <button class="sidebar-btn" onclick="showPanel('classes')"><i class="fas fa-layer-group"></i> <span data-en="Classes" data-ar="الصفوف">Classes</span></button>
            <button class="sidebar-btn" onclick="showPanel('shop')"><i class="fas fa-tshirt"></i> <span data-en="Shop" data-ar="المتجر">Shop</span></button>
            <button class="sidebar-btn" onclick="showPanel('schedule')"><i class="fas fa-calendar-week"></i> <span data-en="Schedule" data-ar="الجدول">Schedule</span></button>
            <button class="sidebar-btn" onclick="showPanel('homework')"><i class="fas fa-book"></i> <span data-en="Homework" data-ar="الواجبات">Homework</span></button>
            <button class="sidebar-btn" onclick="showPanel('bus')"><i class="fas fa-bus"></i> <span data-en="Bus" data-ar="الحافلات">Bus</span></button>
            <button class="sidebar-btn" onclick="showPanel('lunch')"><i class="fas fa-utensils"></i> <span data-en="Lunch" data-ar="الغداء">Lunch</span></button>
            <button class="sidebar-btn" onclick="showPanel('gallery')"><i class="fas fa-images"></i> <span data-en="Gallery" data-ar="المعرض">Gallery</span></button>
            <button class="sidebar-btn" onclick="showPanel('messages')"><i class="fas fa-bullhorn"></i> <span data-en="Broadcast" data-ar="الإعلانات">Broadcast</span></button>
            <button class="sidebar-btn" onclick="showPanel('settings')"><i class="fas fa-cog"></i> <span data-en="Settings" data-ar="الإعدادات">Settings</span></button>
        </div>
        <div class="admin-content">
            
            <div id="students" class="panel active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 data-en="Student & Fee Management" data-ar="إدارة الطلاب والرسوم">Student & Fee Management</h2>
                    <div>
                        <button class="btn btn-secondary" style="margin-right: 10px;" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i> <span data-en="Export PDF" data-ar="تصدير PDF">Export PDF</span>
                        </button>
                        <button class="btn btn-primary" onclick="openStudentModal()">
                            <span data-en="+ Create Account" data-ar="+ إنشاء حساب">+ Create Account</span>
                        </button>
                    </div>
                </div>

                <div class="row mb-4" style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px;">
                        <div class="chart-container">
                            <h5 class="text-muted mb-3" data-en="Financial Overview" data-ar="نظرة عامة مالية">Financial Overview</h5>
                            <canvas id="feesChart"></canvas>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 300px;">
                        <div class="chart-container">
                            <h5 class="text-muted mb-3" data-en="Attendance Trends (6 Months)" data-ar="اتجاهات الحضور (6 أشهر)">Attendance Trends (6 Months)</h5>
                            <canvas id="attendanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label><strong data-en="Filter by Section:" data-ar="تصفية حسب الصف:">Filter by Section:</strong></label>
                        <select id="sectionFilter" class="form-control class-dropdown" onchange="renderTable()">
                            <option value="All" data-en="Show All" data-ar="عرض الكل">Show All</option>
                            </select>
                    </div>
                    <div style="flex: 2; min-width: 200px;">
                        <label><strong data-en="Search Student:" data-ar="بحث عن طالب:">Search Student:</strong></label>
                        <div style="position: relative;">
                            <input type="text" id="studentSearch" class="form-control" placeholder="Search by Name or ID..." onkeyup="renderTable()" style="padding-left: 35px;">
                            <i class="fas fa-search" style="position: absolute; left: 12px; top: 12px; color: #999;"></i>
                        </div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div><h4 data-en="Total Students" data-ar="مجموع الطلاب">Total Students</h4><h2 id="totalStudentsCount">0</h2></div></div>
                    <div class="stat-card"><div><h4 data-en="Total Fees Collected" data-ar="مجموع الرسوم المحصلة">Total Fees Collected</h4><h2 id="totalRevenue">0 JOD</h2></div></div>
                    <div class="stat-card"><div><h4 data-en="Outstanding Fees" data-ar="الرسوم المتبقية">Outstanding Fees</h4><h2 id="totalOutstanding" style="color: #e74c3c;">0 JOD</h2></div></div>
                </div>
                <table class="data-table">
                    <thead><tr>
                        <th data-en="Login ID" data-ar="اسم المستخدم">Login ID</th>
                        <th data-en="Name" data-ar="الاسم">Name</th>
                        <th data-en="Section" data-ar="الصف">Section</th>
                        <th data-en="Fees Paid / Total" data-ar="المدفوع / الكلي">Fees Paid / Total</th>
                        <th data-en="Credit" data-ar="الرصيد">Credit</th>
                        <th data-en="Actions" data-ar="إجراءات">Actions</th>
                    </tr></thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
            </div>

            <div id="teachers" class="panel" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 data-en="Teacher Management" data-ar="إدارة المعلمين">Teacher Management</h2>
                    <button class="btn btn-primary" onclick="openTeacherModal()">
                        <span data-en="+ Add Teacher" data-ar="+ إضافة معلم">+ Add Teacher</span>
                    </button>
                </div>
                <table class="data-table">
                    <thead><tr>
                        <th data-en="Name" data-ar="الاسم">Name</th>
                        <th data-en="Assigned Class" data-ar="الصف المعين">Assigned Class</th>
                        <th data-en="Username" data-ar="اسم المستخدم">Username</th>
                        <th data-en="Password" data-ar="كلمة المرور">Password</th>
                        <th data-en="Actions" data-ar="إجراءات">Actions</th>
                    </tr></thead>
                    <tbody id="teacherTableBody"></tbody>
                </table>
            </div>

            <div id="classes" class="panel" style="display:none;">
                <h2 data-en="Class Management" data-ar="إدارة الصفوف">Class Management</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 20px;">
                            <h5 data-en="Add New Class" data-ar="إضافة صف جديد">Add New Class</h5>
                            <div class="d-flex gap-2 mb-3">
                                <input type="text" id="newClassName" class="form-control mt-0" placeholder="e.g. Grade 1 A">
                                <button class="btn btn-success" onclick="addClass()">
                                    <span data-en="Add" data-ar="إضافة">Add</span>
                                </button>
                            </div>
                            <hr>
                            <h5 data-en="Existing Classes" data-ar="الصفوف الحالية">Existing Classes</h5>
                            <ul id="classList" class="list-group mt-2" style="list-style: none; padding: 0;"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="shop" class="panel" style="display:none;">
                <h2 data-en="Shop & Order Manager" data-ar="إدارة المتجر والطلبات">Shop & Order Manager</h2>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px; color: var(--primary);" data-en="Incoming Orders" data-ar="الطلبات الواردة">Incoming Orders</h3>
                        <div id="ordersContainer" style="max-height: 500px; overflow-y: auto;"><p class="text-muted" data-en="No pending orders." data-ar="لا يوجد طلبات معلقة.">No pending orders.</p></div>
                    </div>
                    <div style="flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px;" data-en="Edit Uniforms" data-ar="تعديل الزي المدرسي">Edit Uniforms</h3>
                        <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                            <h4 style="color: orange; margin-bottom: 5px;" data-en="Summer Uniform" data-ar="الزي الصيفي">Summer Uniform</h4>
                            <div class="drop-zone" style="height: 100px; margin-bottom: 10px;" onclick="document.getElementById('summerInput').click()">
                                <p data-en="Click to Upload Image" data-ar="انقر لرفع صورة">Click to Upload Image</p>
                                <img id="summerPreview" class="preview-img">
                                <input type="file" id="summerInput" hidden accept="image/*">
                            </div>
                            <input type="text" id="summerDesc" class="form-control" placeholder="Description" data-en-ph="Description" data-ar-ph="الوصف">
                            <input type="number" id="summerPrice" class="form-control" placeholder="Price" data-en-ph="Price" data-ar-ph="السعر">
                        </div>
                        <div>
                            <h4 style="color: #3498db; margin-bottom: 5px;" data-en="Winter Uniform" data-ar="الزي الشتوي">Winter Uniform</h4>
                            <div class="drop-zone" style="height: 100px; margin-bottom: 10px;" onclick="document.getElementById('winterInput').click()">
                                <p data-en="Click to Upload Image" data-ar="انقر لرفع صورة">Click to Upload Image</p>
                                <img id="winterPreview" class="preview-img">
                                <input type="file" id="winterInput" hidden accept="image/*">
                            </div>
                            <input type="text" id="winterDesc" class="form-control" placeholder="Description" data-en-ph="Description" data-ar-ph="الوصف">
                            <input type="number" id="winterPrice" class="form-control" placeholder="Price" data-en-ph="Price" data-ar-ph="السعر">
                        </div>
                        <button class="btn btn-primary" onclick="saveShopSettings()" style="width: 100%; margin-top: 20px;">
                            <span data-en="Save Changes" data-ar="حفظ التغييرات">Save Changes</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="schedule" class="panel" style="display:none;">
                <h2 data-en="Weekly Schedule Editor" data-ar="محرر الجدول الأسبوعي">Weekly Schedule Editor</h2>
                <div style="display: flex; gap: 20px; margin-bottom: 20px; background: white; padding: 20px; border-radius: 10px;">
                    <div style="flex: 1;"><label><strong data-en="1. Select Class" data-ar="1. اختر الصف">1. Select Class</strong></label><select id="scheduleClass" class="form-control class-dropdown" onchange="loadDaySchedule()"></select></div>
                    <div style="flex: 1;"><label><strong data-en="2. Select Day" data-ar="2. اختر اليوم">2. Select Day</strong></label><select id="scheduleDay" class="form-control" onchange="loadDaySchedule()"><option value="0" data-en="Sunday" data-ar="الأحد">Sunday</option><option value="1" data-en="Monday" data-ar="الاثنين">Monday</option><option value="2" data-en="Tuesday" data-ar="الثلاثاء">Tuesday</option><option value="3" data-en="Wednesday" data-ar="الأربعاء">Wednesday</option><option value="4" data-en="Thursday" data-ar="الخميس">Thursday</option></select></div>
                </div>
                <div style="background: white; padding: 2rem; border-radius: 10px;">
                    <h4 data-en="Edit Time Slots" data-ar="تعديل الأوقات">Edit Time Slots</h4>
                    <div id="slotsContainer">
                        <div class="schedule-row"><div class="schedule-time">08:00 AM</div><input type="text" id="sub-08" class="form-control" placeholder="Subject" data-en-ph="Subject" data-ar-ph="المادة"><input type="text" id="teach-08" class="form-control" placeholder="Teacher" data-en-ph="Teacher" data-ar-ph="المعلم"></div>
                        <div class="schedule-row"><div class="schedule-time">09:00 AM</div><input type="text" id="sub-09" class="form-control" placeholder="Subject" data-en-ph="Subject" data-ar-ph="المادة"><input type="text" id="teach-09" class="form-control" placeholder="Teacher" data-en-ph="Teacher" data-ar-ph="المعلم"></div>
                        <div class="schedule-row"><div class="schedule-time">11:00 AM</div><input type="text" id="sub-11" class="form-control" placeholder="Subject" data-en-ph="Subject" data-ar-ph="المادة"><input type="text" id="teach-11" class="form-control" placeholder="Teacher" data-en-ph="Teacher" data-ar-ph="المعلم"></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveDaySchedule()" style="width: 100%; margin-top: 20px;">
                        <span data-en="Save Schedule" data-ar="حفظ الجدول">Save Schedule</span>
                    </button>
                </div>
            </div>

            <div id="homework" class="panel" style="display:none;">
                <h2 data-en="Homework Manager" data-ar="إدارة الواجبات">Homework Manager</h2>
                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <div style="flex:1; background: white; padding: 2rem; border-radius: 10px;">
                        <h4 data-en="Post New Assignment" data-ar="نشر واجب جديد">Post New Assignment</h4>
                        <div class="mb-3">
                            <label data-en="Class" data-ar="الصف">Class</label>
                            <select id="hwClass" class="form-control class-dropdown"></select>
                        </div>
                        <div class="mb-3">
                            <label data-en="Subject" data-ar="المادة">Subject</label>
                            <select id="hwSubject" class="form-control">
                                <option value="Math" data-en="Math" data-ar="رياضيات">Math</option>
                                <option value="Science" data-en="Science" data-ar="علوم">Science</option>
                                <option value="English" data-en="English" data-ar="إنجليزي">English</option>
                                <option value="Arabic" data-en="Arabic" data-ar="عربي">Arabic</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label data-en="Due Date" data-ar="تاريخ التسليم">Due Date</label>
                            <input type="date" id="hwDate" class="form-control">
                        </div>
                        <div class="mb-3">
                            <textarea id="hwDesc" class="form-control" rows="3" placeholder="Assignment details..." data-en-ph="Assignment details..." data-ar-ph="تفاصيل الواجب..."></textarea>
                        </div>
                        <button class="btn btn-primary w-100" onclick="postHomework()">
                            <span data-en="Post Assignment" data-ar="نشر الواجب">Post Assignment</span>
                        </button>
                    </div>
                    <div style="flex:1; background: white; padding: 2rem; border-radius: 10px;">
                        <h4 data-en="Active Assignments" data-ar="الواجبات الحالية">Active Assignments</h4>
                        <div id="homeworkListContainer" style="max-height: 400px; overflow-y: auto; margin-top:15px;"></div>
                    </div>
                </div>
            </div>

            <div id="bus" class="panel" style="display:none;">
                <h2 data-en="Bus Route Manager" data-ar="إدارة الحافلات">Bus Route Manager</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 10px;"><h4 style="color: #f39c12;" data-en="Morning Route" data-ar="المسار الصباحي">Morning Route</h4><div style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="busMorningLoc" placeholder="Stop Name" class="form-control" data-en-ph="Stop Name" data-ar-ph="اسم المحطة"><input type="time" id="busMorningTime" class="form-control" style="width: 120px;"><button class="btn btn-primary" onclick="addBusStop('morning')">+</button></div><div id="morningBusList"></div></div>
                    <div style="background: white; padding: 20px; border-radius: 10px;"><h4 style="color: #2c3e50;" data-en="Afternoon Route" data-ar="المسار المسائي">Afternoon Route</h4><div style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="busEveningLoc" placeholder="Stop Name" class="form-control" data-en-ph="Stop Name" data-ar-ph="اسم المحطة"><input type="time" id="busEveningTime" class="form-control" style="width: 120px;"><button class="btn btn-primary" onclick="addBusStop('evening')">+</button></div><div id="eveningBusList"></div></div>
                </div>
            </div>

            <div id="lunch" class="panel" style="display:none;">
                <h2 data-en="Lunch Menu Manager" data-ar="إدارة قائمة الغداء">Lunch Menu Manager</h2>
                <div style="display:flex; gap:20px; flex-wrap:wrap; margin-top: 20px;">
                    <div style="flex:1; background:white; padding:2rem; border-radius:10px;">
                        <h4 data-en="Add Item" data-ar="إضافة عنصر">Add Item</h4>
                        <form onsubmit="addLunchItem(event)">
                            <input type="text" id="lunchName" class="form-control" placeholder="Item Name" required data-en-ph="Item Name" data-ar-ph="اسم الوجبة">
                            <select id="lunchCategory" class="form-control">
                                <option value="sandwiches" data-en="Sandwiches" data-ar="ساندويش">Sandwiches</option>
                                <option value="snacks" data-en="Snacks" data-ar="وجبات خفيفة">Snacks</option>
                                <option value="drinks" data-en="Drinks" data-ar="مشروبات">Drinks</option>
                            </select>
                            <input type="number" id="lunchPrice" step="0.05" class="form-control" placeholder="Price (JOD)" required data-en-ph="Price (JOD)" data-ar-ph="السعر (دينار)">
                            <div class="drop-zone" id="lunchDropZone"><div id="lunchDropText" data-en="Drag Image Here or Click" data-ar="اسحب الصورة هنا أو انقر">Drag Image Here or Click</div><img id="lunchPreview"><input type="file" id="lunchImageInput" accept="image/*" hidden></div>
                            <button type="submit" class="btn btn-primary" style="width:100%;">
                                <span data-en="Add" data-ar="إضافة">Add</span>
                            </button>
                        </form>
                    </div>
                    <div style="flex:2; background:white; padding:2rem; border-radius:10px;">
                        <h4><span data-en="Current Menu" data-ar="القائمة الحالية">Current Menu</span> <button class="btn btn-danger" onclick="clearLunchMenu()" style="float:right; font-size:0.7rem;" data-en="Clear All" data-ar="مسح الكل">Clear All</button></h4>
                        <ul id="adminLunchList" style="list-style:none; padding:0;"></ul>
                    </div>
                </div>
            </div>

            <div id="gallery" class="panel" style="display:none;">
                <h2 data-en="Gallery Manager" data-ar="إدارة المعرض">Gallery Manager</h2>
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;"><div style="display: flex; gap: 10px;"><input type="text" id="galleryCaption" placeholder="Caption" class="form-control" data-en-ph="Caption" data-ar-ph="تعليق"><input type="file" id="galleryInput" accept="image/*" class="form-control"><button class="btn btn-primary" onclick="uploadGalleryImage()" data-en="Upload" data-ar="رفع">Upload</button></div></div>
                <div class="gallery-grid" id="adminGalleryGrid"></div>
            </div>

            <div id="messages" class="panel" style="display:none;">
                <h2 data-en="School Broadcast" data-ar="إذاعة المدرسة">School Broadcast</h2>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; background: white; padding: 2rem; border-radius: 10px;">
                        <h4 style="margin-bottom: 20px; color: #e74c3c;" data-en="Send to All" data-ar="إرسال للجميع">Send to All</h4>
                        <input type="text" id="adminMsgTitle" class="form-control" placeholder="Title" data-en-ph="Title" data-ar-ph="العنوان">
                        <textarea id="adminMsgBody" class="form-control" rows="5" placeholder="Message..." data-en-ph="Message..." data-ar-ph="الرسالة..."></textarea>
                        <button class="btn btn-primary" onclick="sendAdminBroadcast()" style="width: 100%; margin-top:10px;">
                            <span data-en="Send Broadcast" data-ar="إرسال الإعلان">Send Broadcast</span>
                        </button>
                    </div>
                    <div style="flex: 1; background: white; padding: 2rem; border-radius: 10px;">
                        <h4 style="margin-bottom: 20px;" data-en="Recent Broadcasts" data-ar="الإعلانات الأخيرة">Recent Broadcasts</h4>
                        <div id="adminMsgHistory"><p class="text-muted small" data-en="No broadcasts sent yet." data-ar="لم يتم إرسال إعلانات بعد.">No broadcasts sent yet.</p></div>
                    </div>
                </div>
            </div>

            <div id="settings" class="panel" style="display:none;">
                <h2 data-en="Settings" data-ar="الإعدادات">Settings</h2>
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h3 data-en="General" data-ar="عام">General</h3>
                    <p data-en="Use the Shop & Orders panel to set uniform prices now." data-ar="استخدم لوحة المتجر والطلبات لتحديد أسعار الزي الآن.">Use the Shop & Orders panel to set uniform prices now.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between;"><h2 data-en="Create Student Account" data-ar="إنشاء حساب طالب">Create Student Account</h2><span onclick="closeModal('studentModal')" style="cursor:pointer; font-size:1.5rem;">&times;</span></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input type="hidden" id="editIndex"> 
                <div class="login-section">
                    <h4 style="margin-bottom:10px; color:#1976d2;"><i class="fas fa-lock"></i> <span data-en="Parent Login Credentials" data-ar="بيانات دخول ولي الأمر">Parent Login Credentials</span></h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><label data-en="Student ID (Username)" data-ar="رقم الطالب (اسم المستخدم)">Student ID (Username)</label><input type="number" id="sID" class="form-control" placeholder="e.g. 202601"></div>
                        <div><label data-en="Password" data-ar="كلمة المرور">Password</label><input type="text" id="sPass" class="form-control" value="123456" placeholder="Default: 123456"></div>
                    </div>
                </div>
                <div style="grid-column: span 2;"><label data-en="Full Name" data-ar="الاسم الكامل">Full Name</label><input type="text" id="sName" class="form-control" placeholder="Student Full Name"></div>
                <div><label data-en="Section" data-ar="القسم">Section</label><select id="sGrade" class="form-control class-dropdown"></select></div>
                <div><label data-en="Total Fee (JOD)" data-ar="الرسوم الكلية (دينار)">Total Fee (JOD)</label><input type="number" id="sFee" value="1000" class="form-control"></div>
                <div><label data-en="Amount Paid" data-ar="المبلغ المدفوع">Amount Paid</label><input type="number" id="sPaid" value="0" class="form-control"></div>
                <div><label data-en="Credit Balance (JOD)" data-ar="الرصيد (دينار)">Credit Balance (JOD)</label><input type="number" id="sCredit" value="0" class="form-control" step="0.01"></div>
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-secondary" onclick="closeModal('studentModal')"><span data-en="Cancel" data-ar="إلغاء">Cancel</span></button> 
                <button class="btn btn-primary" onclick="saveStudent()"><span data-en="Save Account" data-ar="حفظ الحساب">Save Account</span></button>
            </div>
        </div>
    </div>

    <div id="teacherModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between;"><h2 data-en="Teacher Details" data-ar="تفاصيل المعلم">Teacher Details</h2><span onclick="closeModal('teacherModal')" style="cursor:pointer; font-size:1.5rem;">&times;</span></div>
            <input type="hidden" id="teacherIndex">
            <div class="mb-3"><label data-en="Full Name" data-ar="الاسم الكامل">Full Name</label><input type="text" id="tName" class="form-control" placeholder="Ms. Sarah"></div>
            <div class="mb-3"><label data-en="Assigned Class" data-ar="الصف المعين">Assigned Class</label><select id="tClass" class="form-control class-dropdown"></select></div>
            <div class="mb-3"><label data-en="Username" data-ar="اسم المستخدم">Username</label><input type="text" id="tUser" class="form-control" placeholder="Username"></div>
            <div class="mb-3"><label data-en="Password" data-ar="كلمة المرور">Password</label><input type="text" id="tPass" class="form-control" placeholder="Password"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-secondary" onclick="closeModal('teacherModal')"><span data-en="Cancel" data-ar="إلغاء">Cancel</span></button> 
                <button class="btn btn-primary" onclick="saveTeacher()"><span data-en="Save Teacher" data-ar="حفظ المعلم">Save Teacher</span></button>
            </div>
        </div>
    </div>

    <script src="main.js"></script>
    <script>
        let isArabic = false;
        let students = JSON.parse(localStorage.getItem('viola_students')) || [];
        let teachers = JSON.parse(localStorage.getItem('viola_teachers')) || [];
        let classes = JSON.parse(localStorage.getItem('viola_classes')) || ['KG1 A', 'KG1 B', 'KG2 A', 'KG2 B']; // Classes Logic
        let lunchMenu = JSON.parse(localStorage.getItem('viola_lunch_menu')) || [];
        let galleryData = JSON.parse(localStorage.getItem('viola_gallery')) || [];
        let scheduleData = JSON.parse(localStorage.getItem('viola_schedule_v2')) || {}; 
        let busData = JSON.parse(localStorage.getItem('viola_bus_data')) || { morning: [], evening: [] };
        let notifications = JSON.parse(localStorage.getItem('viola_notifications')) || [];
        let shopData = JSON.parse(localStorage.getItem('viola_shop_data')) || { summer: { price: 15, desc: "Breathable cotton polo.", img: "" }, winter: { price: 25, desc: "Warm wool blazer.", img: "" } };
        let orders = JSON.parse(localStorage.getItem('viola_orders')) || [];
        let homeworkList = JSON.parse(localStorage.getItem('viola_homework')) || []; 
        let selectedLunchImage = "";
        
        let feesChartInstance = null;
        let attendanceChartInstance = null;

        window.onload = function() {
            populateClassDropdowns();
            renderTable(); 
            renderTeacherTable();
            renderClassList();
            loadGallery(); renderLunchMenu(); setupLunchDragAndDrop(); loadDaySchedule(); renderBusLists(); loadAdminHistory(); loadShopSettings(); renderOrders(); renderHomework();
            setupShopImageInputs();
            initCharts();
        };

        function showPanel(id) {
            document.querySelectorAll('.panel').forEach(p => p.style.display='none');
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).style.display='block';
            event.currentTarget.classList.add('active');
        }

        // --- CLASS MANAGEMENT (NEW) ---
        function renderClassList() {
            const list = document.getElementById('classList');
            list.innerHTML = classes.map((c, i) => `
                <li class="list-group-item d-flex justify-content-between align-items-center p-3 border-bottom">
                    <span class="fw-bold">${c}</span>
                    <button class="btn btn-sm btn-danger py-1" onclick="deleteClass(${i})"><i class="fas fa-trash"></i></button>
                </li>
            `).join('');
            localStorage.setItem('viola_classes', JSON.stringify(classes));
            populateClassDropdowns();
        }

        function addClass() {
            const name = document.getElementById('newClassName').value.trim();
            if(name && !classes.includes(name)) {
                classes.push(name);
                document.getElementById('newClassName').value = "";
                renderClassList();
                showToast('success', "Class Added");
            }
        }

        function deleteClass(i) {
            if(confirm("Delete this class?")) {
                classes.splice(i, 1);
                renderClassList();
            }
        }

        function populateClassDropdowns() {
            const dropdowns = document.querySelectorAll('.class-dropdown');
            dropdowns.forEach(dd => {
                const currentVal = dd.value;
                let html = dd.id === 'sectionFilter' ? '<option value="All">All Classes</option>' : '';
                classes.forEach(c => html += `<option value="${c}">${c}</option>`);
                dd.innerHTML = html;
                if(currentVal) dd.value = currentVal;
            });
        }

        // --- TEACHER MANAGEMENT (NEW) ---
        function renderTeacherTable() {
            const tbody = document.getElementById('teacherTableBody');
            tbody.innerHTML = teachers.map((t, i) => `
                <tr>
                    <td>${t.name}</td>
                    <td><span class="badge bg-info text-dark">${t.class}</span></td>
                    <td>${t.username}</td>
                    <td>${t.password}</td>
                    <td>
                        <button class="btn btn-warning py-1 px-2" onclick="previewTeacher(${i})" title="Preview Dashboard"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-secondary py-1 px-2" onclick="openTeacherModal(${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger py-1 px-2" onclick="deleteTeacher(${i})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function openTeacherModal(i=null) {
            document.getElementById('teacherModal').style.display = 'block';
            document.getElementById('teacherIndex').value = i !== null ? i : "-1";
            if(i !== null) {
                const t = teachers[i];
                document.getElementById('tName').value = t.name;
                document.getElementById('tClass').value = t.class;
                document.getElementById('tUser').value = t.username;
                document.getElementById('tPass').value = t.password;
            } else {
                document.getElementById('tName').value = "";
                document.getElementById('tClass').value = classes[0];
                document.getElementById('tUser').value = "";
                document.getElementById('tPass').value = "";
            }
        }

        function saveTeacher() {
            const idx = parseInt(document.getElementById('teacherIndex').value);
            const tObj = {
                name: document.getElementById('tName').value,
                class: document.getElementById('tClass').value,
                username: document.getElementById('tUser').value,
                password: document.getElementById('tPass').value
            };

            if(idx === -1) teachers.push(tObj);
            else teachers[idx] = tObj;

            localStorage.setItem('viola_teachers', JSON.stringify(teachers));
            closeModal('teacherModal');
            renderTeacherTable();
            showToast('success', "Teacher Saved");
        }

        function deleteTeacher(i) {
            if(confirm("Remove this teacher account?")) {
                teachers.splice(i, 1);
                localStorage.setItem('viola_teachers', JSON.stringify(teachers));
                renderTeacherTable();
            }
        }

        // --- PREVIEW FUNCTIONS (NEW) ---
        function previewTeacher(i) {
            const t = teachers[i];
            sessionStorage.setItem('viola_preview_teacher', JSON.stringify(t));
            window.location.href = 'teacher_dashboard.html';
        }

        function previewStudent(i) {
            const s = students[i];
            sessionStorage.setItem('viola_preview_student_id', s.id);
            window.location.href = 'parent_dashboard.html';
        }

        // --- STUDENT MANAGEMENT (Updated with Preview) ---
        function renderTable() {
            const tbody = document.getElementById('studentTableBody');
            const filter = document.getElementById('sectionFilter').value;
            const search = document.getElementById('studentSearch').value.toLowerCase();
            
            tbody.innerHTML = ''; 
            let count=0, totalRev=0, totalOut=0;
            
            students.forEach((s, i) => {
                if((filter === "All" || s.grade === filter) && (s.name.toLowerCase().includes(search) || s.id.toString().includes(search))) {
                    count++; 
                    const paid = parseInt(s.paid || 0), fee = parseInt(s.fee || 1000); 
                    const credit = parseFloat(s.credit || 0).toFixed(2);
                    totalRev += paid; totalOut += (fee - paid);
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.name}</td>
                            <td>${s.grade}</td>
                            <td style="color:${paid>=fee?'green':'orange'}">${paid} / ${fee} JOD</td>
                            <td><span class="badge bg-warning text-dark">${credit} JOD</span></td>
                            <td>
                                <button class="btn btn-warning py-1 px-2" onclick="previewStudent(${i})" title="Preview Portal"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-secondary py-1 px-2" onclick="openStudentModal(${i})"><i class="fas fa-edit"></i></button> 
                                <button class="btn btn-danger py-1 px-2" onclick="deleteStudent(${i})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                }
            });
            document.getElementById('totalStudentsCount').innerText = count; document.getElementById('totalRevenue').innerText = totalRev + " JOD"; document.getElementById('totalOutstanding').innerText = totalOut + " JOD";
        }

        function openStudentModal(i=null) { 
            document.getElementById('studentModal').style.display = 'block'; 
            document.getElementById('editIndex').value = (i!==null) ? i : "-1"; 
            if(i!==null){ 
                const s=students[i]; 
                document.getElementById('sName').value=s.name; document.getElementById('sID').value=s.id; document.getElementById('sPass').value=s.password || "123456"; 
                document.getElementById('sGrade').value=s.grade; document.getElementById('sFee').value=s.fee; document.getElementById('sPaid').value=s.paid; document.getElementById('sCredit').value = s.credit || 0;
            } else { 
                document.getElementById('sName').value=""; document.getElementById('sID').value=""; document.getElementById('sPass').value="123456"; 
                document.getElementById('sFee').value="1000"; document.getElementById('sPaid').value="0"; document.getElementById('sCredit').value="0";
            } 
        }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        
        function saveStudent() { 
            const index = parseInt(document.getElementById('editIndex').value); 
            const oldAttendance = (index !== -1 && students[index].attendance) ? students[index].attendance : "Present"; 
            const creditVal = document.getElementById('sCredit').value || 0;
            const sObj = { 
                id: document.getElementById('sID').value, password: document.getElementById('sPass').value || "123456", 
                name: document.getElementById('sName').value, grade: document.getElementById('sGrade').value, 
                fee: document.getElementById('sFee').value, paid: document.getElementById('sPaid').value, 
                credit: creditVal, attendance: oldAttendance, photo: "" 
            }; 
            if(index === -1) { students.push(sObj); } else { if(students[index].photo) sObj.photo = students[index].photo; students[index] = sObj; }
            localStorage.setItem('viola_student_credit', creditVal); 
            localStorage.setItem('viola_students', JSON.stringify(students)); 
            closeModal('studentModal'); renderTable(); initCharts();
            showToast('success', isArabic ? 'تم حفظ الحساب' : 'Student Account Saved Successfully'); 
        }
        
        function deleteStudent(i) { 
            if(confirm(isArabic ? "هل أنت متأكد؟" : "Delete this student account?")){ 
                students.splice(i,1); localStorage.setItem('viola_students', JSON.stringify(students)); renderTable(); initCharts(); showToast('error', isArabic ? 'تم الحذف' : 'Student Deleted'); 
            } 
        }

        // --- EXPORT PDF ---
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.font = "helvetica";
            doc.setFontSize(18); doc.text("Viola Academy - Student List", 14, 22);
            doc.setFontSize(11); doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 30);
            const tableColumn = ["ID", "Name", "Section", "Total Fee", "Paid", "Balance"];
            const tableRows = [];
            students.forEach(s => { const balance = parseInt(s.fee) - parseInt(s.paid); tableRows.push([s.id, s.name, s.grade, s.fee + " JOD", s.paid + " JOD", balance + " JOD"]); });
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, theme: 'grid', headStyles: { fillColor: [46, 204, 113] } });
            doc.save("Viola_Students_Report.pdf");
            showToast('success', isArabic ? "تم تحميل الملف" : "PDF Downloaded Successfully");
        }

        // --- HOMEWORK, SHOP, ETC. (Kept same logic) ---
        function postHomework() {
            const cls = document.getElementById('hwClass').value; const sub = document.getElementById('hwSubject').value; const date = document.getElementById('hwDate').value; const desc = document.getElementById('hwDesc').value;
            if(!cls || !sub || !date || !desc) { alert(isArabic ? "يرجى تعبئة جميع الحقول" : "Please fill all fields"); return; }
            homeworkList.unshift({ id: Date.now(), class: cls, subject: sub, dueDate: date, description: desc });
            localStorage.setItem('viola_homework', JSON.stringify(homeworkList)); renderHomework(); document.getElementById('hwDesc').value = ""; showToast('success', isArabic ? "تم نشر الواجب" : "Homework Posted Successfully");
        }
        function renderHomework() {
            const container = document.getElementById('homeworkListContainer');
            if(homeworkList.length === 0) { container.innerHTML = `<p class="text-muted text-center py-3">${isArabic ? 'لا يوجد واجبات' : 'No active homework assignments'}</p>`; return; }
            container.innerHTML = homeworkList.map((hw, i) => `<div class="homework-item"><div><div class="mb-1"><span class="homework-badge">${hw.class}</span><span class="homework-badge" style="background:#e3f2fd; color:#1976d2;">${hw.subject}</span><small class="text-danger fw-bold"><i class="far fa-clock"></i> ${hw.dueDate}</small></div><p class="mb-0 small text-secondary">${hw.description}</p></div><button class="btn-delete-sm" onclick="deleteHomework(${i})"><i class="fas fa-trash"></i></button></div>`).join('');
        }
        function deleteHomework(index) { if(confirm("Delete this assignment?")) { homeworkList.splice(index, 1); localStorage.setItem('viola_homework', JSON.stringify(homeworkList)); renderHomework(); } }
        function initCharts() {
            let totalPaid = 0, totalOutstanding = 0;
            students.forEach(s => { const paid = parseInt(s.paid || 0); const fee = parseInt(s.fee || 1000); totalPaid += paid; totalOutstanding += (fee - paid); });
            if(feesChartInstance) feesChartInstance.destroy(); if(attendanceChartInstance) attendanceChartInstance.destroy();
            const labelsFees = isArabic ? ['تم التحصيل', 'المتبقي'] : ['Collected', 'Outstanding'];
            const labelsAtt = isArabic ? 'معدل الحضور %' : 'Attendance Rate %';
            const months = isArabic ? ['أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر', 'يناير'] : ['Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'];
            feesChartInstance = new Chart(document.getElementById('feesChart'), { type: 'doughnut', data: { labels: labelsFees, datasets: [{ data: [totalPaid, totalOutstanding], backgroundColor: ['#2ecc71', '#e74c3c'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false } });
            attendanceChartInstance = new Chart(document.getElementById('attendanceChart'), { type: 'line', data: { labels: months, datasets: [{ label: labelsAtt, data: [85, 88, 92, 90, 85, 94], borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } } });
        }
        function saveShopSettings() { shopData.summer.price = document.getElementById('summerPrice').value; shopData.summer.desc = document.getElementById('summerDesc').value; shopData.winter.price = document.getElementById('winterPrice').value; shopData.winter.desc = document.getElementById('winterDesc').value; localStorage.setItem('viola_shop_data', JSON.stringify(shopData)); localStorage.setItem('viola_summer_price', shopData.summer.price); localStorage.setItem('viola_winter_price', shopData.winter.price); showToast('success', isArabic ? "تم تحديث المتجر" : "Shop Updated Successfully!"); }
        function completeOrder(index) { if(confirm("Mark order as completed?")) { orders.splice(index, 1); localStorage.setItem('viola_orders', JSON.stringify(orders)); renderOrders(); showToast('success', isArabic ? 'تم إكمال الطلب' : 'Order Completed'); } }
        function sendAdminBroadcast() { const t=document.getElementById('adminMsgTitle').value, b=document.getElementById('adminMsgBody').value; if(!t||!b)return; ['KG1 A','KG1 B','KG2 A','KG2 B'].forEach(c=>{ notifications.unshift({id:Date.now()+Math.random(),date:new Date().toLocaleDateString(),targetClass:c,sender:"Admin",title:t,body:b}); }); localStorage.setItem('viola_notifications', JSON.stringify(notifications)); showToast('info', isArabic ? "تم الإرسال" : "Broadcast Sent!"); document.getElementById('adminMsgTitle').value=""; document.getElementById('adminMsgBody').value=""; loadAdminHistory(); }
        function saveDaySchedule(){const c=document.getElementById('scheduleClass').value,d=document.getElementById('scheduleDay').value;if(!scheduleData[c])scheduleData[c]={};scheduleData[c][d]={"08":{sub:document.getElementById('sub-08').value,teach:document.getElementById('teach-08').value},"09":{sub:document.getElementById('sub-09').value,teach:document.getElementById('teach-09').value},"11":{sub:document.getElementById('sub-11').value,teach:document.getElementById('teach-11').value}};localStorage.setItem('viola_schedule_v2',JSON.stringify(scheduleData));showToast('success', isArabic ? "تم حفظ الجدول" : "Schedule Saved!");}
        function toggleLanguage() { isArabic = !isArabic; const lang = isArabic ? 'ar' : 'en'; document.documentElement.setAttribute('dir', isArabic ? 'rtl' : 'ltr'); document.documentElement.setAttribute('lang', lang); document.querySelectorAll('[data-en]').forEach(el => { el.innerText = el.getAttribute(`data-${lang}`); }); document.querySelectorAll('[data-en-ph]').forEach(el => { el.placeholder = el.getAttribute(`data-${lang}-ph`); }); initCharts(); }
        function setupShopImageInputs() { ['summer', 'winter'].forEach(type => { const input = document.getElementById(type + 'Input'); if (input) { input.onchange = (e) => { if(e.target.files[0]) { const r = new FileReader(); r.onload = (ev) => { shopData[type].img = ev.target.result; document.getElementById(type + 'Preview').src = ev.target.result; document.getElementById(type + 'Preview').style.display = 'block'; }; r.readAsDataURL(e.target.files[0]); } }; } }); }
        function loadShopSettings() { if(shopData.summer) { document.getElementById('summerPrice').value = shopData.summer.price; document.getElementById('summerDesc').value = shopData.summer.desc; if(shopData.summer.img) { document.getElementById('summerPreview').src = shopData.summer.img; document.getElementById('summerPreview').style.display = 'block'; } } if(shopData.winter) { document.getElementById('winterPrice').value = shopData.winter.price; document.getElementById('winterDesc').value = shopData.winter.desc; if(shopData.winter.img) { document.getElementById('winterPreview').src = shopData.winter.img; document.getElementById('winterPreview').style.display = 'block'; } } }
        function renderOrders() { const container = document.getElementById('ordersContainer'); if(orders.length === 0) { container.innerHTML = '<p class="text-muted">' + (isArabic ? 'لا يوجد طلبات' : 'No pending orders.') + '</p>'; } else { container.innerHTML = orders.map((o, i) => `<div class="order-card"><div style="display:flex; justify-content:space-between;"><strong>Order #${o.id.toString().slice(-4)}</strong><small>${o.date}</small></div><div style="margin:5px 0;">Parent: ${o.parentName || 'Mr. Masadeh'}</div><ul style="padding-left:20px; margin:5px 0;">${o.items.map(item => `<li>${item.name} (${item.price} JOD)</li>`).join('')}</ul><div style="font-weight:bold; margin-top:5px;">Total: ${o.total} JOD</div><div class="text-secondary small">Paid via: ${o.paymentMethod || 'Cash'}</div><button class="btn btn-primary" style="padding:5px 10px; margin-top:5px; font-size:0.8rem;" onclick="completeOrder(${i})">${isArabic ? 'إكمال' : 'Mark Complete'}</button></div>`).join(''); } }
        function loadAdminHistory() { const u=[], s=new Set(); notifications.filter(m=>m.sender=="Admin").slice(0,5).forEach(m=>{ if(!s.has(m.title)){u.push(m); s.add(m.title);} }); document.getElementById('adminMsgHistory').innerHTML = u.map(m=>`<div class="msg-history-item"><strong>${m.title}</strong><br><small>${m.date}</small></div>`).join(''); }
        function setupLunchDragAndDrop(){const z=document.getElementById('lunchDropZone'),i=document.getElementById('lunchImageInput'),p=document.getElementById('lunchPreview');z.onclick=()=>i.click();i.onchange=(e)=>{if(i.files[0]){const r=new FileReader();r.onload=(ev)=>{selectedLunchImage=ev.target.result;p.src=selectedLunchImage;p.style.display='block';document.getElementById('lunchDropText').style.display='none';};r.readAsDataURL(i.files[0]);}};}
        function addLunchItem(e){e.preventDefault();lunchMenu.push({name:document.getElementById('lunchName').value,category:document.getElementById('lunchCategory').value,price:document.getElementById('lunchPrice').value,image:selectedLunchImage});localStorage.setItem('viola_lunch_menu',JSON.stringify(lunchMenu));renderLunchMenu();}
        function renderLunchMenu(){document.getElementById('adminLunchList').innerHTML=lunchMenu.map((m,i)=>`<li>${m.name} <button style="color:red;border:none;" onclick="deleteLunch(${i})">X</button></li>`).join('');}
        function deleteLunch(i){lunchMenu.splice(i,1);localStorage.setItem('viola_lunch_menu',JSON.stringify(lunchMenu));renderLunchMenu();}
        function clearLunchMenu(){lunchMenu=[];localStorage.setItem('viola_lunch_menu',JSON.stringify(lunchMenu));renderLunchMenu();}
        function uploadGalleryImage(){const i=document.getElementById('galleryInput'),c=document.getElementById('galleryCaption').value;if(i.files[0]){const r=new FileReader();r.onload=(e)=>{galleryData.push({url:e.target.result,caption:c,targetClass:'All'});localStorage.setItem('viola_gallery',JSON.stringify(galleryData));i.value="";loadGallery();};r.readAsDataURL(i.files[0]);}}
        function loadGallery(){document.getElementById('adminGalleryGrid').innerHTML=galleryData.map((m,i)=>`<div style="border:1px solid #ddd;"><img src="${m.url||m}" style="width:100%;height:100px;object-fit:cover;"><button onclick="deleteGallery(${i})" style="width:100%;background:red;color:white;">Delete</button></div>`).join('');}
        function deleteGallery(i){galleryData.splice(i,1);localStorage.setItem('viola_gallery',JSON.stringify(galleryData));loadGallery();}
        function loadDaySchedule(){const c=document.getElementById('scheduleClass').value,d=document.getElementById('scheduleDay').value;const dt=scheduleData[c]?.[d]||{};document.getElementById('sub-08').value=dt["08"]?.sub||"";document.getElementById('teach-08').value=dt["08"]?.teach||"";document.getElementById('sub-09').value=dt["09"]?.sub||"";document.getElementById('teach-09').value=dt["09"]?.teach||"";document.getElementById('sub-11').value=dt["11"]?.sub||"";document.getElementById('teach-11').value=dt["11"]?.teach||"";}
        function renderBusLists(){document.getElementById('morningBusList').innerHTML=busData.morning.map((s,i)=>`<div class="admin-timeline-item"><div><strong>${s.time}</strong> ${s.loc}</div><button class="btn-delete-sm" onclick="delBus('morning',${i})">x</button></div>`).join('');document.getElementById('eveningBusList').innerHTML=busData.evening.map((s,i)=>`<div class="admin-timeline-item"><div><strong>${s.time}</strong> ${s.loc}</div><button class="btn-delete-sm" onclick="delBus('evening',${i})">x</button></div>`).join('');}
        function addBusStop(t){const l=document.getElementById(t=='morning'?'busMorningLoc':'busEveningLoc').value,tm=document.getElementById(t=='morning'?'busMorningTime':'busEveningTime').value;if(l&&tm){busData[t].push({loc:l,time:tm});busData[t].sort((a,b)=>a.time.localeCompare(b.time));localStorage.setItem('viola_bus_data',JSON.stringify(busData));renderBusLists();}}
        function delBus(t,i){busData[t].splice(i,1);localStorage.setItem('viola_bus_data',JSON.stringify(busData));renderBusLists();}
    </script>
</body>
</html>